name: Simplified Rollback

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'ë¡¤ë°±í•  ë²„ì „ (ì˜ˆ: v1.0.0)'
        required: true
        type: string
      confirm_rollback:
        description: 'ë¡¤ë°± í™•ì¸ (yes ì…ë ¥ í•„ìš”)'
        required: true
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    if: inputs.confirm_rollback == 'yes'
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. AWS ìê²©ì¦ëª… ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3. ë¡¤ë°± ëŒ€ìƒ ë²„ì „ í™•ì¸
      - name: Verify target version exists
        run: |
          TARGET_VERSION="${{ inputs.target_version }}"
          BUCKET="woo-bottle.com"
          
          echo "ğŸ” ë¡¤ë°± ëŒ€ìƒ ë²„ì „ í™•ì¸: $TARGET_VERSION"
          
          # ë²„ì „ ì¡´ì¬ í™•ì¸
          if ! aws s3 ls "s3://$BUCKET/versions/$TARGET_VERSION/" > /dev/null 2>&1; then
            echo "âŒ ë²„ì „ $TARGET_VERSIONì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
            echo "ì‚¬ìš© ê°€ëŠ¥í•œ ë²„ì „ ëª©ë¡:"
            aws s3 ls "s3://$BUCKET/versions/" --recursive | grep "/$" | awk '{print $4}' | sed 's|versions/||g' | sed 's|/||g' | sort -V
            exit 1
          fi
          
          echo "âœ… ë²„ì „ $TARGET_VERSION í™•ì¸ë¨"

      # 4. í˜„ì¬ ë²„ì „ ë°±ì—…
      - name: Backup current version
        run: |
          BUCKET="woo-bottle.com"
          BACKUP_TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          
          echo "ğŸ’¾ í˜„ì¬ ë²„ì „ ë°±ì—… ì¤‘..."
          
          # í˜„ì¬ ë²„ì „ì„ ë°±ì—… í´ë”ë¡œ ë³µì‚¬
          aws s3 sync "s3://$BUCKET/current/" "s3://$BUCKET/backups/pre_rollback_$BACKUP_TIMESTAMP/" \
            --exclude "deploy-info.json"
          
          echo "âœ… í˜„ì¬ ë²„ì „ì´ backups/pre_rollback_$BACKUP_TIMESTAMP/ì— ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤"

      # 5. ë¡¤ë°± ì‹¤í–‰
      - name: Execute rollback
        run: |
          TARGET_VERSION="${{ inputs.target_version }}"
          BUCKET="woo-bottle.com"
          
          echo "ğŸ”„ ë¡¤ë°± ì‹¤í–‰ ì¤‘: $TARGET_VERSION"
          
          # ì§€ì •ëœ ë²„ì „ì„ currentë¡œ ë³µì‚¬
          aws s3 sync "s3://$BUCKET/versions/$TARGET_VERSION/" "s3://$BUCKET/current/" \
            --delete \
            --cache-control "max-age=86400"
          
          # ë£¨íŠ¸ì—ë„ ë³µì‚¬
          aws s3 sync "s3://$BUCKET/versions/$TARGET_VERSION/" "s3://$BUCKET/" \
            --delete \
            --cache-control "max-age=86400" \
            --exclude "versions/*" \
            --exclude "backups/*"
          
          echo "âœ… ë¡¤ë°± ì™„ë£Œ: $TARGET_VERSION"

      # 6. ë¡¤ë°± ë©”íƒ€ë°ì´í„° ìƒì„±
      - name: Create rollback metadata
        run: |
          TARGET_VERSION="${{ inputs.target_version }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # ë¡¤ë°± ë©”íƒ€ë°ì´í„° ìƒì„±
          cat > rollback-info.json << EOF
          {
            "rollback_version": "$TARGET_VERSION",
            "rollback_timestamp": "$TIMESTAMP",
            "rollback_by": "${{ github.actor }}",
            "rollback_reason": "Manual rollback via GitHub Actions",
            "original_deployment_info": "See versions/$TARGET_VERSION/deploy-info.json",
            "rollback_workflow_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF
          
          # S3ì— ì—…ë¡œë“œ
          aws s3 cp rollback-info.json s3://woo-bottle.com/rollback-info.json \
            --content-type "application/json" \
            --cache-control "no-cache"
          
          aws s3 cp rollback-info.json s3://woo-bottle.com/current/rollback-info.json \
            --content-type "application/json" \
            --cache-control "no-cache"

      # 7. CloudFront ë¬´íš¨í™” (ì„ íƒì‚¬í•­)
      - name: Invalidate CloudFront
        if: env.CLOUDFRONT_DISTRIBUTION_ID != ''
        uses: chetan/invalidate-cloudfront-action@v2
        env:
          DISTRIBUTION: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
          PATHS: "/*"
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # 8. ë¡¤ë°± ê²°ê³¼ í™•ì¸
      - name: Verify rollback
        run: |
          TARGET_VERSION="${{ inputs.target_version }}"
          BUCKET="woo-bottle.com"
          
          echo "ğŸ” ë¡¤ë°± ê²°ê³¼ í™•ì¸ ì¤‘..."
          
          # í˜„ì¬ ë°°í¬ëœ ë²„ì „ ì •ë³´ í™•ì¸
          if aws s3 cp "s3://$BUCKET/current/version.json" - 2>/dev/null; then
            echo "âœ… ë²„ì „ ì •ë³´ í™•ì¸ë¨"
          else
            echo "âš ï¸ ë²„ì „ ì •ë³´ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤ (ì •ìƒì¼ ìˆ˜ ìˆìŒ)"
          fi
          
          echo "âœ… ë¡¤ë°±ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ·ï¸ ë¡¤ë°±ëœ ë²„ì „: $TARGET_VERSION"
          echo "ğŸŒ URL: https://woo-bottle.com"
          echo "ğŸ“… ë¡¤ë°± ì‹œê°„: $(date)"

  # ë¡¤ë°± ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
  rollback-failed:
    runs-on: ubuntu-latest
    if: failure() || inputs.confirm_rollback != 'yes'
    steps:
      - name: Rollback failed notification
        run: |
          if [[ "${{ inputs.confirm_rollback }}" != "yes" ]]; then
            echo "âŒ ë¡¤ë°±ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. 'yes'ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤."
          else
            echo "âŒ ë¡¤ë°± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!"
            echo "ğŸ”§ ìˆ˜ë™ìœ¼ë¡œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."
          fi
