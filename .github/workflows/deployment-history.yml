name: View Deployment History

on:
  workflow_dispatch:
    inputs:
      history_limit:
        description: 'ì¡°íšŒí•  ë°°í¬ ê¸°ë¡ ìˆ˜ (ê¸°ë³¸ê°’: 10)'
        required: false
        default: '10'
        type: string
      show_details:
        description: 'ìƒì„¸ ì •ë³´ í‘œì‹œ'
        required: false
        default: true
        type: boolean

jobs:
  show-history:
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Download Deployment History
        run: |
          echo "ðŸ“¥ ë°°í¬ ížˆìŠ¤í† ë¦¬ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          
          if aws s3api head-object --bucket woo-bottle.com --key ".deploy-history.json" 2>/dev/null; then
            aws s3 cp s3://woo-bottle.com/.deploy-history.json deploy-history.json
            echo "âœ… ë°°í¬ ížˆìŠ¤í† ë¦¬ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
          else
            echo "âŒ ë°°í¬ ížˆìŠ¤í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "[]" > deploy-history.json
          fi
          
          # í˜„ìž¬ ë°°í¬ ì •ë³´ë„ ë‹¤ìš´ë¡œë“œ
          if aws s3api head-object --bucket woo-bottle.com --key ".current-deploy.json" 2>/dev/null; then
            aws s3 cp s3://woo-bottle.com/.current-deploy.json current-deploy.json
            echo "âœ… í˜„ìž¬ ë°°í¬ ì •ë³´ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
          else
            echo "âš ï¸ í˜„ìž¬ ë°°í¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "{}" > current-deploy.json
          fi

      - name: Display Deployment History
        run: |
          LIMIT="${{ inputs.history_limit }}"
          SHOW_DETAILS="${{ inputs.show_details }}"
          
          echo "ðŸ“Š ë°°í¬ ížˆìŠ¤í† ë¦¬ (ìµœê·¼ $LIMIT ê°œ)"
          echo "================================"
          
          # í˜„ìž¬ ë°°í¬ ì •ë³´
          CURRENT_VERSION=$(jq -r '.deployVersion // "unknown"' current-deploy.json)
          CURRENT_TIME=$(jq -r '.deployTime // "unknown"' current-deploy.json)
          IS_ROLLBACK=$(jq -r '.isRollback // false' current-deploy.json)
          
          echo "ðŸš€ **í˜„ìž¬ ë°°í¬**: $CURRENT_VERSION"
          if [[ "$IS_ROLLBACK" == "true" ]]; then
            ROLLBACK_TIME=$(jq -r '.rolledBackAt // "unknown"' current-deploy.json)
            ROLLBACK_BY=$(jq -r '.rolledBackBy // "unknown"' current-deploy.json)
            echo "   â†³ ðŸ”„ ë¡¤ë°±ë¨ ($ROLLBACK_TIME by $ROLLBACK_BY)"
          fi
          echo ""
          
          # ë°°í¬ ížˆìŠ¤í† ë¦¬ í‘œì‹œ
          TOTAL_DEPLOYS=$(jq length deploy-history.json)
          echo "ðŸ“ˆ ì´ ë°°í¬ ê¸°ë¡: $TOTAL_DEPLOYS ê°œ"
          echo ""
          
          if [[ $TOTAL_DEPLOYS -eq 0 ]]; then
            echo "ë°°í¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 0
          fi
          
          # GitHub Summaryì— í‘œì‹œí•  ë‚´ìš© ì¤€ë¹„
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ“Š ë°°í¬ ížˆìŠ¤í† ë¦¬
          
          ### ðŸš€ í˜„ìž¬ ë°°í¬
          - **ë²„ì „**: \`$CURRENT_VERSION\`
          - **ì‹œê°„**: $CURRENT_TIME
          EOF
          
          if [[ "$IS_ROLLBACK" == "true" ]]; then
            ROLLBACK_TIME=$(jq -r '.rolledBackAt // "unknown"' current-deploy.json)
            ROLLBACK_BY=$(jq -r '.rolledBackBy // "unknown"' current-deploy.json)
            echo "- **ìƒíƒœ**: ðŸ”„ ë¡¤ë°±ë¨ ($ROLLBACK_TIME by $ROLLBACK_BY)" >> $GITHUB_STEP_SUMMARY
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          
          ### ðŸ“‹ ìµœê·¼ ë°°í¬ ê¸°ë¡ (ìµœê·¼ $LIMIT ê°œ)
          
          | ìˆœë²ˆ | ë²„ì „ | ë°°í¬ ì‹œê°„ | ì»¤ë°‹ | ë°°í¬ìž | ì•¡ì…˜ |
          |------|------|-----------|------|--------|------|
          EOF
          
          # ë°°í¬ ê¸°ë¡ì„ í…Œì´ë¸” í˜•íƒœë¡œ ì¶œë ¥
          jq -r --argjson limit "$LIMIT" '
            .[:$limit] | 
            to_entries[] | 
            [
              (.key + 1), 
              .value.deployVersion, 
              .value.deployTime, 
              .value.gitCommitShort, 
              .value.deployedBy,
              if (.value.deployVersion == "'$CURRENT_VERSION'") then "ðŸŸ¢ í˜„ìž¬" else "âšª" end
            ] | 
            @tsv
          ' deploy-history.json | while IFS=$'\t' read -r num version time commit deployer status; do
            echo "| $num | \`$version\` | $time | \`$commit\` | $deployer | $status |" >> $GITHUB_STEP_SUMMARY
            echo "$num. $version ($time) by $deployer $status"
          done

      - name: Show Detailed Information
        if: inputs.show_details == true
        run: |
          echo ""
          echo "ðŸ“‹ ìƒì„¸ ì •ë³´"
          echo "============"
          
          LIMIT="${{ inputs.history_limit }}"
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          
          ### ðŸ“‹ ìƒì„¸ ë°°í¬ ì •ë³´
          
          EOF
          
          jq -r --argjson limit "$LIMIT" '
            .[:$limit] | 
            to_entries[] | 
            "#### " + (.key + 1 | tostring) + ". " + .value.deployVersion + "\n" +
            "- **ë°°í¬ ì‹œê°„**: " + .value.deployTime + "\n" +
            "- **Git ì»¤ë°‹**: [`" + .value.gitCommitShort + "`](https://github.com/${{ github.repository }}/commit/" + .value.gitCommit + ")\n" +
            "- **ì»¤ë°‹ ë©”ì‹œì§€**: " + (.value.gitCommitMessage // "N/A") + "\n" +
            "- **ë°°í¬ìž**: " + .value.deployedBy + "\n" +
            "- **ë¹Œë“œ ë²ˆí˜¸**: " + (.value.buildNumber | tostring) + "\n" +
            "- **ì›Œí¬í”Œë¡œìš°**: [#" + (.value.buildNumber | tostring) + "](" + .value.workflowUrl + ")\n" +
            (if .value.s3VersionIds then "- **S3 ë²„ì „ ê´€ë¦¬**: âœ… í™œì„±í™”" else "- **S3 ë²„ì „ ê´€ë¦¬**: âš ï¸ ë ˆê±°ì‹œ" end) + "\n"
          ' deploy-history.json >> $GITHUB_STEP_SUMMARY

      - name: Show Rollback Options
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          
          ### ðŸ”„ ë¡¤ë°± ì˜µì…˜
          
          ì›í•˜ëŠ” ë²„ì „ìœ¼ë¡œ ë¡¤ë°±í•˜ë ¤ë©´:
          
          1. **Actions** íƒ­ìœ¼ë¡œ ì´ë™
          2. **"S3 Version-Based Rollback"** ì›Œí¬í”Œë¡œìš° ì„ íƒ
          3. **"Run workflow"** í´ë¦­
          4. ë¡¤ë°± íƒ€ìž… ì„ íƒ:
             - **previous**: ë°”ë¡œ ì´ì „ ë°°í¬ë¡œ ë¡¤ë°±
             - **specific**: íŠ¹ì • ë²„ì „ìœ¼ë¡œ ë¡¤ë°± (ìœ„ ëª©ë¡ì—ì„œ ë²„ì „ ë³µì‚¬)
             - **time_based**: íŠ¹ì • ì‹œê°„ ì´í›„ ì²« ë°°í¬ë¡œ ë¡¤ë°±
          5. í™•ì¸ì„ ìœ„í•´ **"ROLLBACK"** ìž…ë ¥
          6. ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
          
          ### ðŸ” S3 ë²„ì €ë‹ ìƒíƒœ
          - **ë²„ì €ë‹**: âœ… í™œì„±í™”ë¨
          - **ë¼ì´í”„ì‚¬ì´í´**: 30ì¼ í›„ ì´ì „ ë²„ì „ ìžë™ ì‚­ì œ
          - **ížˆìŠ¤í† ë¦¬ ë³´ê´€**: ìµœëŒ€ 50ê°œ ë°°í¬ ê¸°ë¡
          
          ### âš ï¸ ì£¼ì˜ì‚¬í•­
          - ë¡¤ë°± ì „ í˜„ìž¬ ìƒíƒœê°€ ìžë™ìœ¼ë¡œ ë°±ì—…ë©ë‹ˆë‹¤
          - CloudFront ìºì‹œ ë¬´íš¨í™”ë¡œ ì¸í•´ ë³€ê²½ì‚¬í•­ ë°˜ì˜ì— ëª‡ ë¶„ ì†Œìš”ë  ìˆ˜ ìžˆìŠµë‹ˆë‹¤
          - ë¬¸ì œ ë°œìƒ ì‹œ ì–¸ì œë“  ë‹¤ì‹œ ë¡¤ë°±í•˜ê±°ë‚˜ ìƒˆë¡œ ë°°í¬í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤
          EOF
          
          echo "âœ… ë°°í¬ ížˆìŠ¤í† ë¦¬ ì¡°íšŒ ì™„ë£Œ"
