name: Simplified S3 Deploy with Versioning

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ë²„ì „ íƒ€ì…'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      custom_version:
        description: 'ì‚¬ìš©ì ì •ì˜ ë²„ì „ (ì˜ˆ: v1.2.0)'
        required: false
        type: string
      auto_version:
        description: 'ìë™ ë²„ì „ ìƒì„±'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      deployment-url: ${{ steps.deploy.outputs.url }}
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Node.js ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. pnpm ì„¤ì¹˜
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 'latest'

      # 4. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 5. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run tests
        run: pnpm test

      # 6. ë¦°íŠ¸ ê²€ì‚¬
      - name: Run linting
        run: pnpm lint

      # 7. ë²„ì „ ê´€ë¦¬ (GitHub Actions ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©)
      - name: Determine version
        id: version
        uses: paulhatch/semantic-version@v5.4.0
        with:
          tag_prefix: "v"
          major_pattern: "(MAJOR)"
          minor_pattern: "(MINOR)"
          version_format: "${major}.${minor}.${patch}"
          bump_each_commit: false
          search_commit_body: false
          user_format_type: "csv"
          enable_prerelease_mode: false

      # 8. ì‚¬ìš©ì ì •ì˜ ë²„ì „ ì²˜ë¦¬
      - name: Handle custom version
        id: final_version
        run: |
          if [[ "${{ inputs.auto_version }}" == "true" ]]; then
            # ìë™ ë²„ì „ ìƒì„±
            case "${{ inputs.version_type }}" in
              "major")
                VERSION="v${{ steps.version.outputs.major_version }}"
                ;;
              "minor")
                VERSION="v${{ steps.version.outputs.minor_version }}"
                ;;
              "patch")
                VERSION="v${{ steps.version.outputs.patch_version }}"
                ;;
            esac
          elif [[ -n "${{ inputs.custom_version }}" ]]; then
            # ì‚¬ìš©ì ì •ì˜ ë²„ì „
            VERSION="${{ inputs.custom_version }}"
          else
            # í˜„ì¬ ë²„ì „ ì‚¬ìš©
            VERSION="v${{ steps.version.outputs.version }}"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ ë°°í¬ ë²„ì „: $VERSION"

      # 9. Git íƒœê·¸ ìƒì„± (ìë™ ë²„ì „ì¸ ê²½ìš°)
      - name: Create Git tag
        if: inputs.auto_version == true
        uses: rickstaa/action-create-tag@v1
        with:
          tag: ${{ steps.final_version.outputs.version }}
          tag_exists_error: false
          message: "Automated release ${{ steps.final_version.outputs.version }}"

      # 10. ë¹Œë“œ
      - name: Build application
        run: pnpm build

      # 11. ë²„ì „ ì •ë³´ ì£¼ì…
      - name: Inject version info
        run: |
          VERSION="${{ steps.final_version.outputs.version }}"
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")
          COMMIT_HASH=$(git rev-parse HEAD)
          SHORT_HASH=$(git rev-parse --short HEAD)
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S %z')
          COMMIT_MESSAGE=$(git log -1 --pretty=%B | head -n1)
          
          # version.js íŒŒì¼ ìƒì„±
          cat > ./out/version.js << EOF
          // ìë™ ìƒì„±ëœ ë²„ì „ ì •ë³´ - ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”
          window.__APP_VERSION__ = {
            "name": "woobottle-labs",
            "version": "$VERSION",
            "packageVersion": "0.1.0",
            "buildTime": "$BUILD_TIME",
            "buildNumber": "${{ github.run_number }}",
            "buildId": "${{ github.run_id }}",
            "git": {
              "commitHash": "$COMMIT_HASH",
              "shortHash": "$SHORT_HASH",
              "branch": "$BRANCH",
              "commitDate": "$COMMIT_DATE",
              "commitMessage": "$COMMIT_MESSAGE",
              "tag": "$VERSION"
            },
            "environment": "production",
            "ci": true,
            "debug": {
              "nodeVersion": "$(node --version)",
              "platform": "$(uname -s | tr '[:upper:]' '[:lower:]')",
              "arch": "$(uname -m)"
            }
          };
          
          // ì „ì—­ í•¨ìˆ˜ë¡œ ë²„ì „ ì •ë³´ ì ‘ê·¼
          window.getAppVersion = function() {
            return window.__APP_VERSION__;
          };
          
          // ì½˜ì†”ì— ë²„ì „ ì •ë³´ ì¶œë ¥
          console.group('ğŸš€ WooBottle Labs - Version Info');
          console.log('Version:', window.__APP_VERSION__.version);
          console.log('Build Time:', window.__APP_VERSION__.buildTime);
          console.log('Commit:', window.__APP_VERSION__.git.shortHash);
          console.log('Branch:', window.__APP_VERSION__.git.branch);
          console.groupEnd();
          EOF
          
          # version.json íŒŒì¼ë„ ìƒì„±
          cat > ./out/version.json << EOF
          {
            "name": "woobottle-labs",
            "version": "$VERSION",
            "buildTime": "$BUILD_TIME",
            "buildNumber": "${{ github.run_number }}",
            "buildId": "${{ github.run_id }}",
            "git": {
              "commitHash": "$COMMIT_HASH",
              "shortHash": "$SHORT_HASH",
              "branch": "$BRANCH",
              "commitDate": "$COMMIT_DATE",
              "commitMessage": "$COMMIT_MESSAGE",
              "tag": "$VERSION"
            },
            "environment": "production",
            "ci": true
          }
          EOF

      # 12. AWS ìê²©ì¦ëª… ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 13. S3ì— ë²„ì „ë³„ ë°°í¬
      - name: Deploy versioned build to S3
        run: |
          VERSION="${{ steps.final_version.outputs.version }}"
          echo "ğŸš€ ë²„ì „ë³„ ë°°í¬: $VERSION"
          aws s3 sync ./out s3://woo-bottle.com/versions/$VERSION/ \
            --delete \
            --cache-control "public, max-age=31536000" \
            --exclude "*.html" \
            --exclude "*.json"
          
          # HTMLê³¼ JSON íŒŒì¼ì€ ë³„ë„ ìºì‹œ ì„¤ì •
          aws s3 sync ./out s3://woo-bottle.com/versions/$VERSION/ \
            --cache-control "no-cache, no-store, must-revalidate" \
            --include "*.html" \
            --include "*.json"

      # 14. í˜„ì¬ ë²„ì „ìœ¼ë¡œ ë°°í¬
      - name: Deploy current version to S3
        run: |
          echo "ğŸš€ í˜„ì¬ ë²„ì „ ë°°í¬"
          aws s3 sync ./out s3://woo-bottle.com/current/ \
            --delete \
            --cache-control "public, max-age=31536000" \
            --exclude "*.html" \
            --exclude "*.json"
          
          # HTMLê³¼ JSON íŒŒì¼ì€ ë³„ë„ ìºì‹œ ì„¤ì •
          aws s3 sync ./out s3://woo-bottle.com/current/ \
            --cache-control "no-cache, no-store, must-revalidate" \
            --include "*.html" \
            --include "*.json"

      # 15. ë£¨íŠ¸ì— ë°°í¬ (ì§ì ‘ ì ‘ê·¼ìš©)
      - name: Deploy to root S3
        run: |
          echo "ğŸš€ ë£¨íŠ¸ ë°°í¬"
          aws s3 sync ./out s3://woo-bottle.com/ \
            --delete \
            --cache-control "public, max-age=31536000" \
            --exclude "*.html" \
            --exclude "*.json" \
            --exclude "versions/*" \
            --exclude "current/*"
          
          # HTMLê³¼ JSON íŒŒì¼ì€ ë³„ë„ ìºì‹œ ì„¤ì •
          aws s3 sync ./out s3://woo-bottle.com/ \
            --cache-control "no-cache, no-store, must-revalidate" \
            --include "*.html" \
            --include "*.json" \
            --exclude "versions/*" \
            --exclude "current/*"

      # 16. S3 ì›¹ì‚¬ì´íŠ¸ í˜¸ìŠ¤íŒ… ì„¤ì •
      - name: Configure S3 website hosting
        run: |
          # ì›¹ì‚¬ì´íŠ¸ ì„¤ì •
          aws s3api put-bucket-website \
            --bucket woo-bottle.com \
            --website-configuration '{
              "IndexDocument": {"Suffix": "index.html"},
              "ErrorDocument": {"Key": "404.html"}
            }'
          
          # ë²„í‚· ì •ì±… ì„¤ì •
          aws s3api put-bucket-policy \
            --bucket woo-bottle.com \
            --policy '{
              "Version": "2012-10-17",
              "Statement": [{
                "Sid": "PublicReadGetObject",
                "Effect": "Allow",
                "Principal": "*",
                "Action": "s3:GetObject",
                "Resource": "arn:aws:s3:::woo-bottle.com/*"
              }]
            }'

      # 17. ë°°í¬ ë©”íƒ€ë°ì´í„° ìƒì„±
      - name: Create deployment metadata
        run: |
          VERSION="${{ steps.final_version.outputs.version }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # ë°°í¬ ë©”íƒ€ë°ì´í„° JSON ìƒì„±
          cat > deploy-info.json << EOF
          {
            "version": "$VERSION",
            "timestamp": "$TIMESTAMP",
            "environment": "production",
            "bucket": "woo-bottle.com",
            "commit_hash": "$(git rev-parse HEAD)",
            "branch": "$(git rev-parse --abbrev-ref HEAD)",
            "build_number": "${{ github.run_number }}",
            "build_id": "${{ github.run_id }}",
            "workflow_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF
          
          # S3ì— ì—…ë¡œë“œ
          aws s3 cp deploy-info.json s3://woo-bottle.com/deploy-info.json \
            --content-type "application/json" \
            --cache-control "no-cache"
          
          aws s3 cp deploy-info.json s3://woo-bottle.com/current/deploy-info.json \
            --content-type "application/json" \
            --cache-control "no-cache"

      # 18. CloudFront ë¬´íš¨í™” (ì„ íƒì‚¬í•­)
      - name: Invalidate CloudFront
        if: env.CLOUDFRONT_DISTRIBUTION_ID != ''
        uses: chetan/invalidate-cloudfront-action@v2
        env:
          DISTRIBUTION: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
          PATHS: "/*"
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # 19. ì˜¤ë˜ëœ ë²„ì „ ì •ë¦¬
      - name: Cleanup old versions
        run: |
          echo "ğŸ§¹ ì˜¤ë˜ëœ ë²„ì „ ì •ë¦¬ ì¤‘..."
          
          # ë²„ì „ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ìµœì‹  3ê°œë§Œ ìœ ì§€)
          aws s3api list-objects-v2 \
            --bucket woo-bottle.com \
            --prefix "versions/" \
            --delimiter "/" \
            --query 'CommonPrefixes[].Prefix' \
            --output text | \
          tr '\t' '\n' | \
          sort -V | \
          head -n -3 | \
          while read -r old_version; do
            if [[ -n "$old_version" ]]; then
              echo "ì‚­ì œ ì¤‘: $old_version"
              aws s3 rm "s3://woo-bottle.com/$old_version" --recursive
            fi
          done

      # 20. ë°°í¬ ê²°ê³¼ ì¶œë ¥
      - name: Deployment summary
        id: deploy
        run: |
          VERSION="${{ steps.final_version.outputs.version }}"
          URL="https://woo-bottle.com"
          
          echo "url=$URL" >> $GITHUB_OUTPUT
          
          echo "âœ… ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ·ï¸ ë²„ì „: $VERSION"
          echo "ğŸŒ URL: $URL"
          echo "ğŸ“… ë°°í¬ ì‹œê°„: $(date)"
          echo "ğŸ”— ì›Œí¬í”Œë¡œìš°: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  # ë°°í¬ í›„ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment notification
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "ğŸ‰ ë°°í¬ ì„±ê³µ!"
            echo "ë²„ì „: ${{ needs.deploy.outputs.version }}"
            echo "URL: ${{ needs.deploy.outputs.deployment-url }}"
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
          fi
