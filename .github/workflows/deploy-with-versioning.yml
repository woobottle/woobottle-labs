name: Deploy with Version Tracking

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸° (emergency only)'
        required: false
        default: false
        type: boolean
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      deploy-version: ${{ steps.version.outputs.version }}
      deploy-url: ${{ steps.summary.outputs.url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 'latest'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        if: inputs.skip_tests != true
        run: pnpm test

      - name: Run linting
        if: inputs.skip_tests != true
        run: pnpm lint

      - name: Generate Deployment Version
        id: version
        run: |
          # ê³ ìœ  ë²„ì „ ìƒì„±: run-ë²ˆí˜¸-ì»¤ë°‹í•´ì‹œ
          VERSION="run-${{ github.run_number }}-$(git rev-parse --short HEAD)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ ë°°í¬ ë²„ì „: $VERSION"

      - name: Build application
        run: pnpm build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy to S3 with Version Tags
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          echo "ðŸš€ S3ì— ë°°í¬ ì¤‘: $VERSION"
          
          # S3 ì—…ë¡œë“œ
          aws s3 sync ./out s3://woo-bottle.com/ \
            --delete \
            --cache-control "public, max-age=3600" \
            --exclude "*.html" \
            --exclude "*.json"
          
          # HTMLê³¼ JSON íŒŒì¼ì€ ë³„ë„ ìºì‹œ ì„¤ì •
          aws s3 sync ./out s3://woo-bottle.com/ \
            --cache-control "no-cache, no-store, must-revalidate" \
            --include "*.html" \
            --include "*.json"
          
          echo "ðŸ·ï¸ íŒŒì¼ íƒœê¹… ì¤‘..."
          
          # ì—…ë¡œë“œëœ ëª¨ë“  íŒŒì¼ì— ë²„ì „ íƒœê·¸ ì¶”ê°€
          aws s3api list-objects-v2 \
            --bucket woo-bottle.com \
            --query 'Contents[?!starts_with(Key, `.`)].Key' \
            --output text | \
          tr '\t' '\n' | \
          while read -r file; do
            if [[ -n "$file" ]]; then
              echo "  ðŸ“„ íƒœê¹…: $file"
              aws s3api put-object-tagging \
                --bucket woo-bottle.com \
                --key "$file" \
                --tagging "TagSet=[{Key=DeployVersion,Value=$VERSION},{Key=DeployTime,Value=$(date -u +%Y-%m-%dT%H:%M:%SZ)},{Key=GitCommit,Value=$(git rev-parse HEAD)},{Key=WorkflowRun,Value=${{ github.run_id }}},{Key=DeployedBy,Value=${{ github.actor }}}]"
            fi
          done

      - name: Create Version Metadata
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          echo "ðŸ“ ë°°í¬ ë©”íƒ€ë°ì´í„° ìƒì„± ì¤‘..."
          
          # ë°°í¬ ë©”íƒ€ë°ì´í„° ìƒì„±
          cat > deploy-metadata.json << EOF
          {
            "deployVersion": "$VERSION",
            "deployTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "gitCommit": "$(git rev-parse HEAD)",
            "gitCommitShort": "$(git rev-parse --short HEAD)",
            "gitBranch": "$(git rev-parse --abbrev-ref HEAD)",
            "gitCommitMessage": "$(git log -1 --pretty=%B | head -n1)",
            "workflowRun": "${{ github.run_id }}",
            "workflowUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "deployedBy": "${{ github.actor }}",
            "buildNumber": "${{ github.run_number }}",
            "repository": "${{ github.repository }}",
            "environment": "production"
          }
          EOF
          
          # S3ì— ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ
          aws s3 cp deploy-metadata.json s3://woo-bottle.com/.deploy-metadata.json \
            --content-type "application/json" \
            --cache-control "no-cache" \
            --metadata "deploy-version=$VERSION,deploy-time=$(date -u +%Y-%m-%dT%H:%M:%SZ)"

      - name: Configure S3 website hosting
        run: |
          echo "ðŸŒ S3 ì›¹ì‚¬ì´íŠ¸ í˜¸ìŠ¤íŒ… ì„¤ì • ì¤‘..."
          
          # ì›¹ì‚¬ì´íŠ¸ ì„¤ì •
          aws s3api put-bucket-website \
            --bucket woo-bottle.com \
            --website-configuration '{
              "IndexDocument": {"Suffix": "index.html"},
              "ErrorDocument": {"Key": "404.html"}
            }'
          
          # ë²„í‚· ì •ì±… ì„¤ì •
          aws s3api put-bucket-policy \
            --bucket woo-bottle.com \
            --policy '{
              "Version": "2012-10-17",
              "Statement": [{
                "Sid": "PublicReadGetObject",
                "Effect": "Allow",
                "Principal": "*",
                "Action": "s3:GetObject",
                "Resource": "arn:aws:s3:::woo-bottle.com/*"
              }]
            }'

      - name: CloudFront cache invalidation
        if: env.CLOUDFRONT_DISTRIBUTION_ID != ''
        uses: chetan/invalidate-cloudfront-action@v2
        env:
          DISTRIBUTION: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
          PATHS: "/*"
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Deployment Summary
        id: summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          URL="https://woo-bottle.com"
          COMMIT_MSG="$(git log -1 --pretty=%B | head -n1)"
          
          echo "url=$URL" >> $GITHUB_OUTPUT
          
          # GitHub ìš”ì•½ì— í‘œì‹œ
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸš€ ë°°í¬ ì™„ë£Œ
          
          | í•­ëª© | ê°’ |
          |------|-----|
          | ðŸ·ï¸ **ë°°í¬ ë²„ì „** | \`$VERSION\` |
          | ðŸŒ **URL** | [$URL]($URL) |
          | ðŸ“… **ë°°í¬ ì‹œê°„** | $(date) |
          | ðŸ”— **ì›Œí¬í”Œë¡œìš°** | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
          | ðŸ“ **ì»¤ë°‹** | [\`$(git rev-parse --short HEAD)\`](${{ github.server_url }}/${{ github.repository }}/commit/$(git rev-parse HEAD)) |
          | ðŸ’¬ **ì»¤ë°‹ ë©”ì‹œì§€** | $COMMIT_MSG |
          | ðŸ‘¤ **ë°°í¬ìž** | ${{ github.actor }} |
          
          ### ðŸ”„ ë¡¤ë°±ì´ í•„ìš”í•œ ê²½ìš°
          1. Actions íƒ­ì—ì„œ **"Version-Based Rollback"** ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
          2. **ë¹ ë¥¸ ë¡¤ë°±**: target_versionì„ ë¹„ì›Œë‘ê³  ì‹¤í–‰ (ë°”ë¡œ ì´ì „ ë²„ì „ìœ¼ë¡œ)
          3. **íŠ¹ì • ë²„ì „**: ì´ì „ ë°°í¬ ë²„ì „ì„ ìž…ë ¥ (ì˜ˆ: \`run-120-abc1234\`)
          
          ### ðŸ“Š ë°°í¬ ì •ë³´
          - **í…ŒìŠ¤íŠ¸ ì‹¤í–‰**: ${{ inputs.skip_tests != true && 'âœ… ì™„ë£Œ' || 'âš ï¸ ê±´ë„ˆëœ€' }}
          - **íŒŒì¼ ìˆ˜**: $(aws s3api list-objects-v2 --bucket woo-bottle.com --query 'length(Contents)' --output text)ê°œ
          - **ë²„ì „ ê´€ë¦¬**: S3 ê°ì²´ ë²„ì €ë‹ í™œì„±í™”
          EOF

  # ë°°í¬ í›„ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment notification
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "ðŸŽ‰ ë°°í¬ ì„±ê³µ!"
            echo "ë²„ì „: ${{ needs.deploy.outputs.deploy-version }}"
            echo "URL: ${{ needs.deploy.outputs.deploy-url }}"
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
            echo "ì›Œí¬í”Œë¡œìš°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
