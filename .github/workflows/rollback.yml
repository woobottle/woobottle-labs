name: Quick Rollback

on:
  workflow_dispatch:
    inputs:
      target_release:
        description: 'ë¡¤ë°±í•  ë¦´ë¦¬ìŠ¤ íƒœê·¸ (ë¹„ì›Œë‘ë©´ ì´ì „ ë²„ì „ìœ¼ë¡œ)'
        required: false
      rollback_steps:
        description: 'ëª‡ ë‹¨ê³„ ì´ì „ìœ¼ë¡œ ë¡¤ë°±? (1 = ë°”ë¡œ ì´ì „, 2 = 2ë‹¨ê³„ ì´ì „)'
        required: false
        default: '1'

jobs:
  rollback:
    runs-on: ubuntu-latest

    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-2

    - name: Determine rollback target
      env:
        TARGET_RELEASE: ${{ github.event.inputs.target_release }}
        ROLLBACK_STEPS: ${{ github.event.inputs.rollback_steps }}
      run: |
        BUCKET="woo-bottle.com"

        echo "ğŸ“‹ ë¦´ë¦¬ìŠ¤ ë©”íƒ€ë°ì´í„° ì¡°íšŒ ì¤‘..."

        # ë©”íƒ€ë°ì´í„° ë‹¤ìš´ë¡œë“œ
        if ! aws s3 cp "s3://$BUCKET/releases-metadata.json" /tmp/metadata.json 2>/dev/null; then
          echo "âŒ ë¦´ë¦¬ìŠ¤ ë©”íƒ€ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          echo "   ë¨¼ì € ìƒˆ ë°°í¬ ì‹œìŠ¤í…œìœ¼ë¡œ ë°°í¬ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”."
          exit 1
        fi

        CURRENT=$(jq -r '.current' /tmp/metadata.json)
        TOTAL_RELEASES=$(jq '.releases | length' /tmp/metadata.json)

        echo "   í˜„ì¬ ë²„ì „: $CURRENT"
        echo "   ì‚¬ìš© ê°€ëŠ¥í•œ ë¦´ë¦¬ìŠ¤ ìˆ˜: $TOTAL_RELEASES"
        echo ""

        # ì‚¬ìš© ê°€ëŠ¥í•œ ë¦´ë¦¬ìŠ¤ ëª©ë¡ í‘œì‹œ
        echo "ğŸ“¦ ì‚¬ìš© ê°€ëŠ¥í•œ ë¦´ë¦¬ìŠ¤:"
        jq -r '.releases[] | "   - \(.tag) (\(.timestamp))"' /tmp/metadata.json
        echo ""

        # ë¡¤ë°± ëŒ€ìƒ ê²°ì •
        if [ -n "$TARGET_RELEASE" ]; then
          # íŠ¹ì • ë¦´ë¦¬ìŠ¤ë¡œ ë¡¤ë°±
          ROLLBACK_TARGET="$TARGET_RELEASE"

          # í•´ë‹¹ ë¦´ë¦¬ìŠ¤ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if ! jq -e --arg tag "$ROLLBACK_TARGET" '.releases[] | select(.tag == $tag)' /tmp/metadata.json > /dev/null; then
            echo "âŒ ë¦´ë¦¬ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $ROLLBACK_TARGET"
            exit 1
          fi
        else
          # Në‹¨ê³„ ì´ì „ìœ¼ë¡œ ë¡¤ë°±
          STEPS="${ROLLBACK_STEPS:-1}"

          # í˜„ì¬ ë²„ì „ì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
          CURRENT_INDEX=$(jq --arg current "$CURRENT" '[.releases[].tag] | to_entries | .[] | select(.value == $current) | .key' /tmp/metadata.json)

          if [ -z "$CURRENT_INDEX" ]; then
            echo "âš ï¸ í˜„ì¬ ë²„ì „ì´ ë¦´ë¦¬ìŠ¤ ëª©ë¡ì— ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±í•©ë‹ˆë‹¤."
            CURRENT_INDEX=0
            STEPS=0
          fi

          TARGET_INDEX=$((CURRENT_INDEX + STEPS))

          if [ "$TARGET_INDEX" -ge "$TOTAL_RELEASES" ]; then
            echo "âŒ ë¡¤ë°±í•  ìˆ˜ ìˆëŠ” ì´ì „ ë²„ì „ì´ ì—†ìŠµë‹ˆë‹¤."
            echo "   ìš”ì²­: ${STEPS}ë‹¨ê³„ ì´ì „"
            echo "   ì‚¬ìš© ê°€ëŠ¥: $((TOTAL_RELEASES - CURRENT_INDEX - 1))ë‹¨ê³„"
            exit 1
          fi

          ROLLBACK_TARGET=$(jq -r ".releases[$TARGET_INDEX].tag" /tmp/metadata.json)
        fi

        echo "ğŸ¯ ë¡¤ë°± ëŒ€ìƒ: $ROLLBACK_TARGET"
        echo "ROLLBACK_TARGET=$ROLLBACK_TARGET" >> $GITHUB_ENV

        # ë¡¤ë°± ëŒ€ìƒ ë¦´ë¦¬ìŠ¤ê°€ S3ì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        if ! aws s3 ls "s3://$BUCKET/releases/$ROLLBACK_TARGET/" > /dev/null 2>&1; then
          echo "âŒ ë¦´ë¦¬ìŠ¤ íŒŒì¼ì´ S3ì— ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: releases/$ROLLBACK_TARGET/"
          exit 1
        fi

        echo "âœ… ë¡¤ë°± ëŒ€ìƒ í™•ì¸ ì™„ë£Œ"

    - name: Update CloudFront Origin Path
      env:
        ROLLBACK_TARGET: ${{ env.ROLLBACK_TARGET }}
        DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
      run: |
        # Note: ROLLBACK_TARGET comes from releases-metadata.json (validated internally)
        NEW_ORIGIN_PATH="/releases/$ROLLBACK_TARGET"

        echo "ğŸ”„ CloudFront Origin Path ì—…ë°ì´íŠ¸ ì¤‘..."
        echo "   ë¡¤ë°± ë²„ì „: $ROLLBACK_TARGET"
        echo "   ìƒˆ Origin Path: $NEW_ORIGIN_PATH"

        # í˜„ì¬ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        aws cloudfront get-distribution-config --id "$DISTRIBUTION_ID" > /tmp/cf-config.json
        ETAG=$(jq -r '.ETag' /tmp/cf-config.json)

        # Default Behaviorì˜ TargetOriginId í™•ì¸
        DEFAULT_ORIGIN_ID=$(jq -r '.DistributionConfig.DefaultCacheBehavior.TargetOriginId' /tmp/cf-config.json)
        CURRENT_PATH=$(jq -r --arg id "$DEFAULT_ORIGIN_ID" \
          '.DistributionConfig.Origins.Items[] | select(.Id == $id) | .OriginPath' /tmp/cf-config.json)

        echo "   Default Origin ID: $DEFAULT_ORIGIN_ID"
        echo "   í˜„ì¬ Origin Path: $CURRENT_PATH"
        echo "   ETag: $ETAG"

        # Origin Path ì—…ë°ì´íŠ¸ (Default Behaviorê°€ ì‚¬ìš©í•˜ëŠ” Originë§Œ)
        jq --arg path "$NEW_ORIGIN_PATH" \
           --arg originId "$DEFAULT_ORIGIN_ID" \
           '.DistributionConfig.Origins.Items = [
              .DistributionConfig.Origins.Items[] |
              if .Id == $originId then .OriginPath = $path else . end
            ]' \
           /tmp/cf-config.json | jq '.DistributionConfig' > /tmp/cf-config-updated.json

        # CloudFront ì—…ë°ì´íŠ¸
        aws cloudfront update-distribution \
          --id "$DISTRIBUTION_ID" \
          --if-match "$ETAG" \
          --distribution-config file:///tmp/cf-config-updated.json > /dev/null

        echo "âœ… CloudFront Origin Path ì—…ë°ì´íŠ¸ ì™„ë£Œ"

    - name: Update releases metadata
      env:
        ROLLBACK_TARGET: ${{ env.ROLLBACK_TARGET }}
      run: |
        BUCKET="woo-bottle.com"

        echo "ğŸ“‹ ë¦´ë¦¬ìŠ¤ ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘..."

        # ë©”íƒ€ë°ì´í„° ë‹¤ìš´ë¡œë“œ
        aws s3 cp "s3://$BUCKET/releases-metadata.json" /tmp/metadata.json

        # current ì—…ë°ì´íŠ¸
        jq --arg current "$ROLLBACK_TARGET" '.current = $current' /tmp/metadata.json > /tmp/metadata-updated.json

        # S3ì— ì—…ë¡œë“œ
        aws s3 cp /tmp/metadata-updated.json "s3://$BUCKET/releases-metadata.json" \
          --content-type "application/json"

        echo "âœ… ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ"

    - name: Invalidate CloudFront cache
      env:
        DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
      run: |
        echo "ğŸ”„ CloudFront ìºì‹œ ë¬´íš¨í™” ì¤‘..."

        INVALIDATION_ID=$(aws cloudfront create-invalidation \
          --distribution-id "$DISTRIBUTION_ID" \
          --paths "/*" \
          --query 'Invalidation.Id' --output text)

        echo "âœ… ìºì‹œ ë¬´íš¨í™” ìš”ì²­ ì™„ë£Œ"
        echo "   Invalidation ID: $INVALIDATION_ID"

    - name: Rollback summary
      env:
        ROLLBACK_TARGET: ${{ env.ROLLBACK_TARGET }}
      run: |
        echo ""
        echo "==================================="
        echo "ğŸ‰ ë¡¤ë°± ì™„ë£Œ!"
        echo "==================================="
        echo "ğŸ“Œ ë¡¤ë°±ëœ ë²„ì „: $ROLLBACK_TARGET"
        echo "ğŸŒ CloudFront Origin Path: /releases/$ROLLBACK_TARGET"
        echo ""
        echo "â±ï¸ ìºì‹œ ë¬´íš¨í™”ê°€ ì „íŒŒë˜ëŠ” ë° 1-2ë¶„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        echo ""
        echo "ğŸ’¡ ì´ì „ ë²„ì „ ì‚¬ìš©ìë„ /releases/* Behaviorë¥¼ í†µí•´"
        echo "   ì²­í¬ ì—ëŸ¬ ì—†ì´ ì´ì „ ë²„ì „ì„ ê³„ì† ì‚¬ìš©í•©ë‹ˆë‹¤."
        echo "==================================="
