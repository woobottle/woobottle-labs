name: Rollback Deployment

on:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ì „ìš©
    inputs:
      rollback_version:
        description: 'ë¡¤ë°±í•  ë²„ì „ (ì˜ˆ: v1.0.1)'
        required: true
        type: string
      environment:
        description: 'ë¡¤ë°± í™˜ê²½'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  rollback:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Validate Rollback Version
        run: |
          # ë²„ì „ í˜•ì‹ í™•ì¸
          if [[ ! "${{ inputs.rollback_version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ë²„ì „ í˜•ì‹: ${{ inputs.rollback_version }}"
            echo "ì˜¬ë°”ë¥¸ í˜•ì‹: v1.0.0"
            exit 1
          fi
          
          # í™˜ê²½ë³„ ë²„í‚· ì„¤ì •
          if [[ "${{ inputs.environment }}" == "staging" ]]; then
            TARGET_BUCKET="woo-bottle-staging.com"
          else
            TARGET_BUCKET="woo-bottle.com"
          fi
          
          # ë²„ì „ ì¡´ì¬ í™•ì¸
          if ! aws s3 ls "s3://$TARGET_BUCKET/versions/${{ inputs.rollback_version }}/" &>/dev/null; then
            echo "âŒ ë²„ì „ ${{ inputs.rollback_version }}ì´ ${{ inputs.environment }} í™˜ê²½ì— ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
            echo "ì‚¬ìš© ê°€ëŠ¥í•œ ë²„ì „:"
            aws s3 ls "s3://$TARGET_BUCKET/versions/" | grep "PRE" | awk '{print $2}' | sed 's/\///g' | sort -V
            exit 1
          fi
          
          echo "âœ… ë¡¤ë°± ë²„ì „ ${{ inputs.rollback_version }} í™•ì¸ë¨"

      - name: Execute Rollback
        run: |
          # ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x ./scripts/rollback.sh
          
          # í™˜ê²½ë³„ ì˜µì…˜ ì„¤ì •
          if [[ "${{ inputs.environment }}" == "staging" ]]; then
            ROLLBACK_ARGS="--staging"
          else
            ROLLBACK_ARGS=""
          fi
          
          # ë¡¤ë°± ì‹¤í–‰
          ./scripts/rollback.sh --version ${{ inputs.rollback_version }} $ROLLBACK_ARGS

      - name: Rollback Summary
        run: |
          echo "âœ… ë¡¤ë°±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ”„ ë¡¤ë°± ë²„ì „: ${{ inputs.rollback_version }}"
          echo "ğŸ¯ í™˜ê²½: ${{ inputs.environment }}"
          
          if [[ "${{ inputs.environment }}" == "staging" ]]; then
            echo "ğŸŒ ìŠ¤í…Œì´ì§• ë²„í‚·: woo-bottle-staging.com"
            echo "ğŸ”— ìŠ¤í…Œì´ì§• URL: https://woo-bottle-staging.com.s3-website.${{ secrets.AWS_REGION }}.amazonaws.com"
          else
            echo "ğŸŒ í”„ë¡œë•ì…˜ ë²„í‚·: woo-bottle.com"
            if [[ -n "${{ secrets.DEPLOYMENT_URL }}" ]]; then
              echo "ğŸ”— í”„ë¡œë•ì…˜ URL: ${{ secrets.DEPLOYMENT_URL }}"
            else
              echo "ğŸ”— í”„ë¡œë•ì…˜ URL: https://woo-bottle.com.s3-website.${{ secrets.AWS_REGION }}.amazonaws.com"
            fi
          fi
          
          echo "ğŸ•’ ë¡¤ë°± ì‹œê°„: $(date)"
          echo "ğŸ’¾ ë°±ì—…: ìë™ìœ¼ë¡œ ìƒì„±ë¨ (backups/ í´ë”)"

      - name: Create Rollback Issue
        if: inputs.environment == 'production'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”„ í”„ë¡œë•ì…˜ ë¡¤ë°± ì•Œë¦¼: ${{ inputs.rollback_version }}`,
              body: `## ğŸ”„ í”„ë¡œë•ì…˜ ë¡¤ë°± ì™„ë£Œ
              
              **ë¡¤ë°± ì •ë³´:**
              - ğŸ·ï¸ ë¡¤ë°± ë²„ì „: ${{ inputs.rollback_version }}
              - ğŸ•’ ë¡¤ë°± ì‹œê°„: ${new Date().toISOString()}
              - ğŸ¤– ì‹¤í–‰ì: ${{ github.actor }}
              - ğŸ”— ì›Œí¬í”Œë¡œìš°: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              **ë°±ì—… ì •ë³´:**
              - ğŸ’¾ ì´ì „ ë²„ì „ì´ ìë™ìœ¼ë¡œ ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤
              - ğŸ“ ë°±ì—… ìœ„ì¹˜: S3 ë²„í‚·ì˜ backups/ í´ë”
              
              **ë‹¤ìŒ ë‹¨ê³„:**
              - [ ] ë¡¤ë°±ëœ ë²„ì „ì´ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
              - [ ] í•„ìš”ì‹œ ì¶”ê°€ ì¡°ì¹˜ ê³„íš ìˆ˜ë¦½
              - [ ] ë¡¤ë°± ì›ì¸ ë¶„ì„ ë° ë¬¸ì„œí™”
              
              cc: @${{ github.actor }}`,
              labels: ['rollback', 'production', 'urgent']
            });
            
            console.log('ë¡¤ë°± ì´ìŠˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤:', issue.html_url);
