name: Rollback Full Website Deployment

on:
  workflow_dispatch:
    inputs:
      deployment_tag:
        description: 'Rollbackí•  ë°°í¬ íƒœê·¸ (ì˜ˆ: deploy-20241215-143022-a1b2c3d)'
        required: false
      custom_version:
        description: 'íŠ¹ì • ë²„ì „ìœ¼ë¡œ ë¡¤ë°± (ë©”íƒ€ë°ì´í„°ì˜ version ê°’, ì˜ˆ: v1.2.3)'
        required: false
      rollback_mode:
        description: 'ë¡¤ë°± ëª¨ë“œ ì„ íƒ'
        required: true
        default: 'tag'
        type: choice
        options:
        - tag
        - version

jobs:
  rollback:
    runs-on: ubuntu-latest
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-2 # ë³¸ì¸ S3 ë²„í‚· ë¦¬ì „ìœ¼ë¡œ ë³€ê²½

    - name: Rollback deployment
      run: |
        BUCKET="woo-bottle.com"
        ROLLBACK_MODE="${{ github.event.inputs.rollback_mode }}"
        DEPLOYMENT_TAG="${{ github.event.inputs.deployment_tag }}"
        CUSTOM_VERSION="${{ github.event.inputs.custom_version }}"
        
        echo "ë¡¤ë°±ì„ ì‹œì‘í•©ë‹ˆë‹¤."
        echo "ë¡¤ë°± ëª¨ë“œ: ${ROLLBACK_MODE}"
        
        if [ "$ROLLBACK_MODE" = "tag" ]; then
          if [ -z "$DEPLOYMENT_TAG" ]; then
            echo "âŒ ì—ëŸ¬: íƒœê·¸ ëª¨ë“œì—ì„œëŠ” deployment_tagê°€ í•„ìš”í•©ë‹ˆë‹¤."
            exit 1
          fi
          echo "ë°°í¬ íƒœê·¸: ${DEPLOYMENT_TAG}"
          SEARCH_CRITERIA="deployment"
          SEARCH_VALUE="$DEPLOYMENT_TAG"
        elif [ "$ROLLBACK_MODE" = "version" ]; then
          if [ -z "$CUSTOM_VERSION" ]; then
            echo "âŒ ì—ëŸ¬: ë²„ì „ ëª¨ë“œì—ì„œëŠ” custom_versionì´ í•„ìš”í•©ë‹ˆë‹¤."
            exit 1
          fi
          echo "ëŒ€ìƒ ë²„ì „: ${CUSTOM_VERSION}"
          SEARCH_CRITERIA="version"
          SEARCH_VALUE="$CUSTOM_VERSION"
        fi
        
        echo "==================================="
        echo "âš¡ ê³ ì† ë¡¤ë°± ëª¨ë“œë¡œ ëŒ€ìƒ íŒŒì¼ë“¤ì„ ì°¾ëŠ” ì¤‘..."
        
        ROLLBACK_COUNT=0
        TEMP_FILE="/tmp/rollback_targets_$$"
        
        # 1ë‹¨ê³„: ëª¨ë“  ê°ì²´ì™€ ë²„ì „ì„ í•œ ë²ˆì— ê°€ì ¸ì™€ì„œ ì„ì‹œ íŒŒì¼ì— ì €ì¥
        echo "ğŸ“‹ S3 ê°ì²´ ëª©ë¡ ìˆ˜ì§‘ ì¤‘..."
        aws s3api list-object-versions --bucket $BUCKET --output json > /tmp/all_versions_$$.json
        
        # 2ë‹¨ê³„: jqë¥¼ ì‚¬ìš©í•´ í•œ ë²ˆì— í•„í„°ë§í•˜ì—¬ ëŒ€ìƒ íŒŒì¼ë“¤ ì°¾ê¸°
        echo "ğŸ” ë©”íƒ€ë°ì´í„° ê¸°ë°˜ ëŒ€ìƒ ë²„ì „ ê²€ìƒ‰ ì¤‘..."
        
        # ë³‘ë ¬ë¡œ ë©”íƒ€ë°ì´í„° ê²€ì‚¬í•  íŒŒì¼ ëª©ë¡ ìƒì„±
        jq -r '.Versions[] | select(.IsLatest != true) | "\(.Key)|\(.VersionId)"' /tmp/all_versions_$$.json | head -10000 > $TEMP_FILE
        
        # 3ë‹¨ê³„: ë³‘ë ¬ ì²˜ë¦¬ë¡œ ë©”íƒ€ë°ì´í„° ê²€ì‚¬ ë° ë¡¤ë°±
        echo "ğŸš€ ë³‘ë ¬ ì²˜ë¦¬ë¡œ ë¡¤ë°± ì‹¤í–‰ ì¤‘..."
        
        export BUCKET SEARCH_CRITERIA SEARCH_VALUE ROLLBACK_MODE
        
        # ë³‘ë ¬ ì²˜ë¦¬ í•¨ìˆ˜
        process_file() {
          local key_version="$1"
          local key=$(echo "$key_version" | cut -d'|' -f1)
          local version_id=$(echo "$key_version" | cut -d'|' -f2)
          
          # ë©”íƒ€ë°ì´í„° í™•ì¸
          METADATA=$(aws s3api head-object --bucket "$BUCKET" --key "$key" --version-id "$version_id" --query "Metadata" --output json 2>/dev/null || echo "{}")
          METADATA_VALUE=$(echo "$METADATA" | jq -r ".\"$SEARCH_CRITERIA\" // empty" 2>/dev/null || echo "")
          
          if [ "$METADATA_VALUE" = "$SEARCH_VALUE" ]; then
            echo "âœ… ëŒ€ìƒ ë°œê²¬: $key (v:$version_id)"
            
            # ê¸°ì¡´ ë©”íƒ€ë°ì´í„° ì²˜ë¦¬
            ORIGINAL_METADATA=$(echo "$METADATA" | jq -r 'to_entries | map("\(.key)=\(.value)") | join(",")')
            ROLLBACK_TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            ROLLBACK_METADATA="rollback-timestamp=$ROLLBACK_TIMESTAMP,rolled-back-from=$SEARCH_VALUE,rollback-mode=$ROLLBACK_MODE"
            
            if [ -n "$ORIGINAL_METADATA" ] && [ "$ORIGINAL_METADATA" != "null" ]; then
              FULL_METADATA="$ORIGINAL_METADATA,$ROLLBACK_METADATA"
            else
              FULL_METADATA="$ROLLBACK_METADATA"
            fi
            
            # ê³ ì† ë¡¤ë°± ì‹¤í–‰
            if aws s3api copy-object \
              --bucket "$BUCKET" \
              --key "$key" \
              --copy-source "$BUCKET/$key?versionId=$version_id" \
              --metadata "$FULL_METADATA" \
              --metadata-directive REPLACE >/dev/null 2>&1; then
              echo "   âš¡ $key ë¡¤ë°± ì™„ë£Œ!"
              return 0
            else
              echo "   âŒ $key ë¡¤ë°± ì‹¤íŒ¨"
              return 1
            fi
          fi
          return 2
        }
        
        export -f process_file
        
        # GNU parallel ì‚¬ìš© (ì—†ìœ¼ë©´ xargsë¡œ í´ë°±)
        if command -v parallel >/dev/null 2>&1; then
          echo "ğŸ”¥ GNU parallelë¡œ ì´ˆê³ ì† ì²˜ë¦¬ ì¤‘..."
          ROLLBACK_COUNT=$(cat $TEMP_FILE | parallel -j 10 process_file | grep -c "ë¡¤ë°± ì™„ë£Œ")
        else
          echo "âš¡ xargsë¡œ ë³‘ë ¬ ì²˜ë¦¬ ì¤‘..."
          ROLLBACK_COUNT=$(cat $TEMP_FILE | xargs -n 1 -P 8 -I {} bash -c 'process_file "{}"' | grep -c "ë¡¤ë°± ì™„ë£Œ")
        fi
        
        # ì„ì‹œ íŒŒì¼ ì •ë¦¬
        rm -f $TEMP_FILE /tmp/all_versions_$$.json
        
        echo ""
        echo "==================================="
        echo "ë¡¤ë°±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ë¡¤ë°± ëª¨ë“œ: ${ROLLBACK_MODE}"
        if [ "$ROLLBACK_MODE" = "tag" ]; then
          echo "ë¡¤ë°±ëœ ë°°í¬ íƒœê·¸: ${DEPLOYMENT_TAG}"
        else
          echo "ë¡¤ë°±ëœ ë²„ì „: ${CUSTOM_VERSION}"
        fi
        echo "ì²˜ë¦¬ëœ íŒŒì¼ ìˆ˜: ${ROLLBACK_COUNT}"
        echo "==================================="
    
    - name: Invalidate CloudFront cache after rollback
      run: |
        echo "CloudFront ìºì‹œë¥¼ ë¬´íš¨í™”í•˜ëŠ” ì¤‘..."
        aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"
        echo "CloudFront ìºì‹œ ë¬´íš¨í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."