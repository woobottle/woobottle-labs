name: Deploy Static Website to S3

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-2

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 'latest'

    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

    - name: Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Cache node_modules
      uses: actions/cache@v4
      with:
        path: node_modules
        key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-node-modules-

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Generate deployment tag
      run: |
        DEPLOYMENT_TAG="deploy-$(date +%Y%m%d-%H%M%S)-$(echo $GITHUB_SHA | cut -c1-7)"
        echo "DEPLOYMENT_TAG=$DEPLOYMENT_TAG" >> $GITHUB_ENV
        echo "Generated deployment tag: $DEPLOYMENT_TAG"

    - name: Build with versioned asset prefix
      env:
        DEPLOYMENT_TAG: ${{ env.DEPLOYMENT_TAG }}
      run: |
        echo "ğŸ”¨ ë¹Œë“œ ì‹œì‘ (assetPrefix: /releases/$DEPLOYMENT_TAG)"
        pnpm build

    - name: Upload to versioned release path
      env:
        DEPLOYMENT_TAG: ${{ env.DEPLOYMENT_TAG }}
      run: |
        BUCKET="woo-bottle.com"
        RELEASE_PATH="releases/$DEPLOYMENT_TAG"

        echo "ğŸš€ ë°°í¬ ì‹œì‘: $DEPLOYMENT_TAG"
        echo "ğŸ“ ë¦´ë¦¬ìŠ¤ ê²½ë¡œ: s3://$BUCKET/$RELEASE_PATH/"

        # ë²„ì „ë³„ ê²½ë¡œì— ì—…ë¡œë“œ
        aws s3 sync ./out/ "s3://$BUCKET/$RELEASE_PATH/" \
          --metadata "deployment=$DEPLOYMENT_TAG,version=$(jq -r .version package.json 2>/dev/null || echo 'unknown'),build-timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)"

        echo "âœ… S3 ì—…ë¡œë“œ ì™„ë£Œ"

    - name: Upload PWA assets to root
      run: |
        BUCKET="woo-bottle.com"

        echo "ğŸ“± PWA ì—ì…‹ì„ ë£¨íŠ¸ì— ì—…ë¡œë“œ ì¤‘..."

        # PWA ì—ì…‹ì´ ì¡´ì¬í•˜ë©´ ë£¨íŠ¸ì— ì—…ë¡œë“œ
        if [ -f ./out/manifest.json ]; then
          aws s3 cp ./out/manifest.json "s3://$BUCKET/manifest.json"
          echo "   âœ“ manifest.json"
        fi

        if [ -f ./out/sw.js ]; then
          aws s3 cp ./out/sw.js "s3://$BUCKET/sw.js"
          echo "   âœ“ sw.js"
        fi

        if [ -d ./out/icons ]; then
          aws s3 sync ./out/icons/ "s3://$BUCKET/icons/"
          echo "   âœ“ icons/"
        fi

        echo "âœ… PWA ì—ì…‹ ì—…ë¡œë“œ ì™„ë£Œ"

    - name: Update releases metadata
      env:
        DEPLOYMENT_TAG: ${{ env.DEPLOYMENT_TAG }}
      run: |
        BUCKET="woo-bottle.com"
        METADATA_KEY="releases-metadata.json"

        echo "ğŸ“‹ ë¦´ë¦¬ìŠ¤ ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘..."

        # ê¸°ì¡´ ë©”íƒ€ë°ì´í„° ë‹¤ìš´ë¡œë“œ (ì—†ìœ¼ë©´ ì´ˆê¸°í™”)
        if aws s3 cp "s3://$BUCKET/$METADATA_KEY" /tmp/metadata.json 2>/dev/null; then
          echo "   ê¸°ì¡´ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì™„ë£Œ"
        else
          echo "   ë©”íƒ€ë°ì´í„° íŒŒì¼ ì—†ìŒ, ìƒˆë¡œ ìƒì„±"
          echo '{"current":"","releases":[],"maxReleases":5}' > /tmp/metadata.json
        fi

        # ìƒˆ ë¦´ë¦¬ìŠ¤ ì •ë³´ ìƒì„±
        NEW_RELEASE=$(jq -n \
          --arg tag "$DEPLOYMENT_TAG" \
          --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
          --arg commitSha "$(echo $GITHUB_SHA | cut -c1-7)" \
          --arg version "$(jq -r .version package.json 2>/dev/null || echo 'unknown')" \
          '{tag: $tag, timestamp: $timestamp, commitSha: $commitSha, version: $version}')

        # ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸: ìƒˆ ë¦´ë¦¬ìŠ¤ ì¶”ê°€, current ì—…ë°ì´íŠ¸
        jq --argjson newRelease "$NEW_RELEASE" \
           --arg current "$DEPLOYMENT_TAG" \
           '.current = $current | .releases = [$newRelease] + .releases' \
           /tmp/metadata.json > /tmp/metadata-updated.json

        # S3ì— ì—…ë¡œë“œ
        aws s3 cp /tmp/metadata-updated.json "s3://$BUCKET/$METADATA_KEY" \
          --content-type "application/json"

        echo "âœ… ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ"
        echo "   í˜„ì¬ ë²„ì „: $DEPLOYMENT_TAG"
        echo "   ì´ ë¦´ë¦¬ìŠ¤ ìˆ˜: $(jq '.releases | length' /tmp/metadata-updated.json)"

    - name: Update CloudFront Origin Path
      env:
        DEPLOYMENT_TAG: ${{ env.DEPLOYMENT_TAG }}
        DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
      run: |
        NEW_ORIGIN_PATH="/releases/$DEPLOYMENT_TAG"

        echo "ğŸ”„ CloudFront Origin Path ì—…ë°ì´íŠ¸ ì¤‘..."
        echo "   ìƒˆ Origin Path: $NEW_ORIGIN_PATH"

        # í˜„ì¬ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        aws cloudfront get-distribution-config --id "$DISTRIBUTION_ID" > /tmp/cf-config.json
        ETAG=$(jq -r '.ETag' /tmp/cf-config.json)

        echo "   í˜„ì¬ ETag: $ETAG"

        # Origin Path ì—…ë°ì´íŠ¸ (Default Originë§Œ)
        jq --arg path "$NEW_ORIGIN_PATH" \
           '.DistributionConfig.Origins.Items[0].OriginPath = $path' \
           /tmp/cf-config.json | jq '.DistributionConfig' > /tmp/cf-config-updated.json

        # CloudFront ì—…ë°ì´íŠ¸
        aws cloudfront update-distribution \
          --id "$DISTRIBUTION_ID" \
          --if-match "$ETAG" \
          --distribution-config file:///tmp/cf-config-updated.json > /dev/null

        echo "âœ… CloudFront Origin Path ì—…ë°ì´íŠ¸ ì™„ë£Œ"

    - name: Cleanup old releases
      run: |
        BUCKET="woo-bottle.com"
        MAX_RELEASES=5

        echo "ğŸ§¹ ì˜¤ë˜ëœ ë¦´ë¦¬ìŠ¤ ì •ë¦¬ ì¤‘..."

        # ë©”íƒ€ë°ì´í„°ì—ì„œ ë¦´ë¦¬ìŠ¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        aws s3 cp "s3://$BUCKET/releases-metadata.json" /tmp/metadata.json

        TOTAL_RELEASES=$(jq '.releases | length' /tmp/metadata.json)
        echo "   í˜„ì¬ ë¦´ë¦¬ìŠ¤ ìˆ˜: $TOTAL_RELEASES"

        if [ "$TOTAL_RELEASES" -gt "$MAX_RELEASES" ]; then
          echo "   ìµœëŒ€ $MAX_RELEASESê°œ ì´ˆê³¼, ì •ë¦¬ ì‹œì‘..."

          # ì‚­ì œí•  ë¦´ë¦¬ìŠ¤ íƒœê·¸ ëª©ë¡
          RELEASES_TO_DELETE=$(jq -r ".releases[$MAX_RELEASES:][].tag" /tmp/metadata.json)

          for TAG in $RELEASES_TO_DELETE; do
            echo "   ğŸ—‘ï¸ ì‚­ì œ ì¤‘: $TAG"
            aws s3 rm "s3://$BUCKET/releases/$TAG/" --recursive
          done

          # ë©”íƒ€ë°ì´í„°ì—ì„œë„ ì œê±°
          jq ".releases = .releases[:$MAX_RELEASES]" /tmp/metadata.json > /tmp/metadata-cleaned.json
          aws s3 cp /tmp/metadata-cleaned.json "s3://$BUCKET/releases-metadata.json" \
            --content-type "application/json"

          echo "âœ… ì •ë¦¬ ì™„ë£Œ: $((TOTAL_RELEASES - MAX_RELEASES))ê°œ ë¦´ë¦¬ìŠ¤ ì‚­ì œë¨"
        else
          echo "   ì •ë¦¬ ë¶ˆí•„ìš” (ìµœëŒ€ $MAX_RELEASESê°œ ì´í•˜)"
        fi

    - name: Invalidate CloudFront cache
      env:
        DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
      run: |
        echo "ğŸ”„ CloudFront ìºì‹œ ë¬´íš¨í™” ì¤‘..."

        INVALIDATION_ID=$(aws cloudfront create-invalidation \
          --distribution-id "$DISTRIBUTION_ID" \
          --paths "/*" \
          --query 'Invalidation.Id' --output text)

        echo "âœ… ìºì‹œ ë¬´íš¨í™” ìš”ì²­ ì™„ë£Œ"
        echo "   Invalidation ID: $INVALIDATION_ID"

    - name: Deployment summary
      env:
        DEPLOYMENT_TAG: ${{ env.DEPLOYMENT_TAG }}
      run: |
        echo ""
        echo "==================================="
        echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
        echo "==================================="
        echo "ğŸ“Œ ë°°í¬ íƒœê·¸: $DEPLOYMENT_TAG"
        echo "ğŸ“ S3 ê²½ë¡œ: s3://woo-bottle.com/releases/$DEPLOYMENT_TAG/"
        echo "ğŸŒ CloudFront Origin Path: /releases/$DEPLOYMENT_TAG"
        echo ""
        echo "ğŸ’¡ ì´ì „ ë²„ì „ ì‚¬ìš©ìë„ /releases/* Behaviorë¥¼ í†µí•´"
        echo "   ì²­í¬ ì—ëŸ¬ ì—†ì´ ì´ì „ ë²„ì „ì„ ê³„ì† ì‚¬ìš©í•©ë‹ˆë‹¤."
        echo "==================================="
