name: S3 Version-Based Rollback

on:
  workflow_dispatch:
    inputs:
      target_deployment:
        description: 'ë¡¤ë°±í•  ë°°í¬ ë²„ì „ (ì˜ˆ: run-120-abc1234) ë˜ëŠ” ì‹œê°„ëŒ€ (ì˜ˆ: 2024-01-15T10:30:00Z)'
        required: false
        type: string
      rollback_type:
        description: 'ë¡¤ë°± íƒ€ìž…'
        required: true
        default: 'previous'
        type: choice
        options:
          - previous        # ë°”ë¡œ ì´ì „ ë°°í¬ë¡œ ë¡¤ë°±
          - specific        # íŠ¹ì • ë°°í¬ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±
          - time_based      # íŠ¹ì • ì‹œê°„ ì´í›„ ì²« ë²ˆì§¸ ë°°í¬ë¡œ ë¡¤ë°±
      confirm_rollback:
        description: 'ë¡¤ë°± í™•ì¸ (ROLLBACK ìž…ë ¥)'
        required: true
        type: string

jobs:
  validate-rollback:
    runs-on: ubuntu-latest
    outputs:
      target-deploy: ${{ steps.find-target.outputs.target_deploy }}
      rollback-safe: ${{ steps.validate.outputs.safe }}
    
    steps:
      - name: Validate Rollback Confirmation
        run: |
          if [[ "${{ inputs.confirm_rollback }}" != "ROLLBACK" ]]; then
            echo "âŒ ë¡¤ë°± í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. 'ROLLBACK'ì„ ì •í™•ížˆ ìž…ë ¥í•´ì£¼ì„¸ìš”."
            exit 1
          fi
          echo "âœ… ë¡¤ë°± í™•ì¸ë¨"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Download Deployment History
        run: |
          echo "ðŸ“¥ ë°°í¬ ížˆìŠ¤í† ë¦¬ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          
          if aws s3api head-object --bucket woo-bottle.com --key ".deploy-history.json" 2>/dev/null; then
            aws s3 cp s3://woo-bottle.com/.deploy-history.json deploy-history.json
          else
            echo "âŒ ë°°í¬ ížˆìŠ¤í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          # í˜„ìž¬ ë°°í¬ ì •ë³´ ë‹¤ìš´ë¡œë“œ
          if aws s3api head-object --bucket woo-bottle.com --key ".current-deploy.json" 2>/dev/null; then
            aws s3 cp s3://woo-bottle.com/.current-deploy.json current-deploy.json
          else
            echo "âš ï¸ í˜„ìž¬ ë°°í¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "{}" > current-deploy.json
          fi

      - name: Find Target Deployment
        id: find-target
        run: |
          ROLLBACK_TYPE="${{ inputs.rollback_type }}"
          TARGET_INPUT="${{ inputs.target_deployment }}"
          
          echo "ðŸ” ë¡¤ë°± ëŒ€ìƒ ì°¾ëŠ” ì¤‘... (íƒ€ìž…: $ROLLBACK_TYPE)"
          
          case $ROLLBACK_TYPE in
            "previous")
              # í˜„ìž¬ ë°°í¬ë¥¼ ì œì™¸í•œ ê°€ìž¥ ìµœê·¼ ë°°í¬
              TARGET_DEPLOY=$(jq -r '.[1] // empty' deploy-history.json)
              ;;
            "specific")
              if [[ -z "$TARGET_INPUT" ]]; then
                echo "âŒ íŠ¹ì • ë°°í¬ ë²„ì „ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”."
                exit 1
              fi
              # íŠ¹ì • ë°°í¬ ë²„ì „ ì°¾ê¸°
              TARGET_DEPLOY=$(jq --arg version "$TARGET_INPUT" '.[] | select(.deployVersion == $version)' deploy-history.json)
              ;;
            "time_based")
              if [[ -z "$TARGET_INPUT" ]]; then
                echo "âŒ ëŒ€ìƒ ì‹œê°„ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 2024-01-15T10:30:00Z)"
                exit 1
              fi
              # íŠ¹ì • ì‹œê°„ ì´í›„ ì²« ë²ˆì§¸ ë°°í¬ ì°¾ê¸°
              TARGET_TIMESTAMP=$(date -d "$TARGET_INPUT" +%s 2>/dev/null || echo "0")
              if [[ $TARGET_TIMESTAMP -eq 0 ]]; then
                echo "âŒ ìž˜ëª»ëœ ì‹œê°„ í˜•ì‹ìž…ë‹ˆë‹¤."
                exit 1
              fi
              TARGET_DEPLOY=$(jq --argjson ts "$TARGET_TIMESTAMP" '.[] | select(.deployTimestamp >= $ts) | last' deploy-history.json)
              ;;
          esac
          
          if [[ -z "$TARGET_DEPLOY" || "$TARGET_DEPLOY" == "null" ]]; then
            echo "âŒ ë¡¤ë°± ëŒ€ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          echo "ðŸŽ¯ ë¡¤ë°± ëŒ€ìƒ ë°œê²¬:"
          echo "$TARGET_DEPLOY" | jq .
          
          # ëŒ€ìƒ ë°°í¬ ì •ë³´ ì €ìž¥
          echo "$TARGET_DEPLOY" > target-deploy.json
          TARGET_VERSION=$(echo "$TARGET_DEPLOY" | jq -r '.deployVersion')
          echo "target_deploy=$TARGET_VERSION" >> $GITHUB_OUTPUT

      - name: Validate Rollback Safety
        id: validate
        run: |
          TARGET_DEPLOY=$(cat target-deploy.json)
          CURRENT_DEPLOY=$(cat current-deploy.json)
          
          echo "ðŸ” ë¡¤ë°± ì•ˆì „ì„± ê²€ì¦ ì¤‘..."
          
          # í˜„ìž¬ ë°°í¬ì™€ ë™ì¼í•œì§€ í™•ì¸
          CURRENT_VERSION=$(echo "$CURRENT_DEPLOY" | jq -r '.deployVersion // "unknown"')
          TARGET_VERSION=$(echo "$TARGET_DEPLOY" | jq -r '.deployVersion')
          
          if [[ "$CURRENT_VERSION" == "$TARGET_VERSION" ]]; then
            echo "âš ï¸ í˜„ìž¬ ë°°í¬ì™€ ë™ì¼í•œ ë²„ì „ìž…ë‹ˆë‹¤. ë¡¤ë°±ì´ í•„ìš”í•˜ì§€ ì•Šì„ ìˆ˜ ìžˆìŠµë‹ˆë‹¤."
          fi
          
          # S3 ë²„ì „ ID ì¡´ìž¬ í™•ì¸
          VERSION_IDS=$(echo "$TARGET_DEPLOY" | jq '.s3VersionIds // {}')
          if [[ "$VERSION_IDS" == "{}" ]]; then
            echo "âš ï¸ S3 ë²„ì „ ID ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë ˆê±°ì‹œ ë°°í¬ì¼ ìˆ˜ ìžˆìŠµë‹ˆë‹¤."
          fi
          
          echo "safe=true" >> $GITHUB_OUTPUT
          echo "âœ… ë¡¤ë°± ì•ˆì „ì„± ê²€ì¦ ì™„ë£Œ"

  rollback:
    needs: validate-rollback
    runs-on: ubuntu-latest
    if: needs.validate-rollback.outputs.rollback-safe == 'true'
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Download Target Deployment Info
        run: |
          # ë°°í¬ ížˆìŠ¤í† ë¦¬ì—ì„œ ëŒ€ìƒ ì •ë³´ ë‹¤ìš´ë¡œë“œ
          aws s3 cp s3://woo-bottle.com/.deploy-history.json deploy-history.json
          
          TARGET_VERSION="${{ needs.validate-rollback.outputs.target-deploy }}"
          jq --arg version "$TARGET_VERSION" '.[] | select(.deployVersion == $version)' deploy-history.json > target-deploy.json
          
          echo "ðŸŽ¯ ë¡¤ë°± ëŒ€ìƒ ì •ë³´:"
          cat target-deploy.json | jq .

      - name: Backup Current State
        run: |
          echo "ðŸ’¾ í˜„ìž¬ ìƒíƒœ ë°±ì—… ì¤‘..."
          
          # í˜„ìž¬ ìƒíƒœë¥¼ ë¡¤ë°± ë°±ì—…ìœ¼ë¡œ ì €ìž¥
          BACKUP_TIME=$(date -u +%Y%m%d-%H%M%S)
          BACKUP_KEY=".rollback-backups/backup-$BACKUP_TIME.json"
          
          # í˜„ìž¬ ë°°í¬ ì •ë³´ë¥¼ ë°±ì—…
          if aws s3api head-object --bucket woo-bottle.com --key ".current-deploy.json" 2>/dev/null; then
            aws s3 cp s3://woo-bottle.com/.current-deploy.json s3://woo-bottle.com/$BACKUP_KEY
            echo "âœ… í˜„ìž¬ ìƒíƒœê°€ $BACKUP_KEY ì— ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤."
          fi

      - name: Restore S3 Object Versions
        run: |
          echo "ðŸ”„ S3 ê°ì²´ ë²„ì „ ë³µì› ì¤‘..."
          
          TARGET_DEPLOY=$(cat target-deploy.json)
          VERSION_IDS=$(echo "$TARGET_DEPLOY" | jq -r '.s3VersionIds // {}')
          
          if [[ "$VERSION_IDS" == "{}" ]]; then
            echo "âš ï¸ S3 ë²„ì „ IDê°€ ì—†ìŠµë‹ˆë‹¤. ì „ì²´ ê°ì²´ ëª©ë¡ì„ ì´ì „ ìƒíƒœë¡œ ë³µì›í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "ëŒ€ì‹  ê°€ëŠ¥í•œ ëª¨ë“  ê°ì²´ì˜ ì´ì „ ë²„ì „ì„ ë³µì›í•©ë‹ˆë‹¤..."
            
            # ëª¨ë“  ê°ì²´ì˜ ì´ì „ ë²„ì „ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            aws s3api list-object-versions --bucket woo-bottle.com --query 'Versions[?IsLatest==`false`]' --output json > all-versions.json
            
            # ëŒ€ìƒ ë°°í¬ ì‹œê°„ ì´ì „ì˜ ê°€ìž¥ ìµœê·¼ ë²„ì „ë“¤ ë³µì› (ë³µìž¡í•œ ë¡œì§ì´ë¯€ë¡œ ê°„ë‹¨ížˆ ì²˜ë¦¬)
            echo "âš ï¸ ë ˆê±°ì‹œ ë°°í¬ ë³µì›ì€ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬ê°€ í•„ìš”í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤."
          else
            echo "ðŸ“„ ê°œë³„ íŒŒì¼ ë²„ì „ ë³µì› ì¤‘..."
            
            # ê° íŒŒì¼ì˜ íŠ¹ì • ë²„ì „ ë³µì›
            echo "$VERSION_IDS" | jq -r 'to_entries[] | "\(.key) \(.value)"' | while read -r file version_id; do
              echo "  ðŸ”„ ë³µì› ì¤‘: $file (ë²„ì „: $version_id)"
              
              # í•´ë‹¹ ë²„ì „ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ë‹¤ì‹œ ì—…ë¡œë“œ (ìµœì‹  ë²„ì „ìœ¼ë¡œ ë§Œë“¤ê¸°)
              aws s3api get-object \
                --bucket woo-bottle.com \
                --key "$file" \
                --version-id "$version_id" \
                "/tmp/restore-$file" || continue
              
              # íŒŒì¼ì„ ë‹¤ì‹œ ì—…ë¡œë“œ (ìƒˆë¡œìš´ ìµœì‹  ë²„ì „ ìƒì„±)
              aws s3 cp "/tmp/restore-$file" "s3://woo-bottle.com/$file" \
                --cache-control "$([ "${file##*.}" == "html" ] && echo "no-cache, no-store, must-revalidate" || echo "public, max-age=3600")"
              
              echo "  âœ… ë³µì› ì™„ë£Œ: $file"
            done
          fi

      - name: Update Current Deployment Metadata
        run: |
          echo "ðŸ“ í˜„ìž¬ ë°°í¬ ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘..."
          
          TARGET_DEPLOY=$(cat target-deploy.json)
          
          # ë¡¤ë°± ì •ë³´ ì¶”ê°€
          ROLLBACK_INFO=$(echo "$TARGET_DEPLOY" | jq --arg rollback_time "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg rollback_by "${{ github.actor }}" \
            --arg rollback_run "${{ github.run_id }}" \
            '. + {
              "rolledBackAt": $rollback_time,
              "rolledBackBy": $rollback_by,
              "rollbackWorkflowRun": $rollback_run,
              "isRollback": true
            }')
          
          # í˜„ìž¬ ë°°í¬ ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸
          echo "$ROLLBACK_INFO" > current-deploy.json
          aws s3 cp current-deploy.json s3://woo-bottle.com/.current-deploy.json \
            --content-type "application/json" \
            --cache-control "no-cache"

      - name: Verify Rollback
        run: |
          echo "âœ… ë¡¤ë°± ê²€ì¦ ì¤‘..."
          
          # ì£¼ìš” íŒŒì¼ë“¤ì´ ì ‘ê·¼ ê°€ëŠ¥í•œì§€ í™•ì¸
          ERRORS=0
          for file in "index.html" "404.html"; do
            if aws s3api head-object --bucket woo-bottle.com --key "$file" >/dev/null 2>&1; then
              echo "  âœ… $file ì ‘ê·¼ ê°€ëŠ¥"
            else
              echo "  âŒ $file ì ‘ê·¼ ë¶ˆê°€"
              ERRORS=$((ERRORS + 1))
            fi
          done
          
          if [[ $ERRORS -gt 0 ]]; then
            echo "âš ï¸ $ERRORS ê°œì˜ íŒŒì¼ì— ë¬¸ì œê°€ ìžˆìŠµë‹ˆë‹¤."
          else
            echo "ðŸŽ‰ ëª¨ë“  ì£¼ìš” íŒŒì¼ ì ‘ê·¼ ê°€ëŠ¥"
          fi

      - name: CloudFront Invalidation
        if: env.CLOUDFRONT_DISTRIBUTION_ID != ''
        uses: chetan/invalidate-cloudfront-action@v2
        env:
          DISTRIBUTION: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
          PATHS: "/*"
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Rollback Summary
        run: |
          TARGET_DEPLOY=$(cat target-deploy.json)
          TARGET_VERSION=$(echo "$TARGET_DEPLOY" | jq -r '.deployVersion')
          TARGET_TIME=$(echo "$TARGET_DEPLOY" | jq -r '.deployTime')
          TARGET_COMMIT=$(echo "$TARGET_DEPLOY" | jq -r '.gitCommitShort')
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ”„ ë¡¤ë°± ì™„ë£Œ
          
          | í•­ëª© | ê°’ |
          |------|-----|
          | ðŸŽ¯ **ë¡¤ë°±ëœ ë²„ì „** | \`$TARGET_VERSION\` |
          | ðŸ“… **ì›ë³¸ ë°°í¬ ì‹œê°„** | $TARGET_TIME |
          | ðŸ”— **ì»¤ë°‹** | \`$TARGET_COMMIT\` |
          | ðŸ”„ **ë¡¤ë°± ì‹œê°„** | $(date) |
          | ðŸ‘¤ **ë¡¤ë°± ì‹¤í–‰ìž** | ${{ github.actor }} |
          | ðŸŒ **ì‚¬ì´íŠ¸ URL** | [https://woo-bottle.com](https://woo-bottle.com) |
          
          ### ðŸ“‹ ë¡¤ë°± ì„¸ë¶€ì‚¬í•­
          - **ë¡¤ë°± íƒ€ìž…**: ${{ inputs.rollback_type }}
          - **ì›Œí¬í”Œë¡œìš°**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - **S3 ë²„ì €ë‹**: âœ… í™œìš©ë¨
          - **ë°±ì—…**: í˜„ìž¬ ìƒíƒœê°€ ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤
          
          ### âš ï¸ ì£¼ì˜ì‚¬í•­
          - ë¡¤ë°±ëœ ë²„ì „ì˜ ë™ìž‘ì„ í™•ì¸í•´ì£¼ì„¸ìš”
          - ë¬¸ì œê°€ ìžˆë‹¤ë©´ ë‹¤ì‹œ ìµœì‹  ë²„ì „ìœ¼ë¡œ ë°°í¬í•˜ê±°ë‚˜ ë‹¤ë¥¸ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤
          - CloudFront ìºì‹œ ë¬´íš¨í™”ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ëª‡ ë¶„ ì†Œìš”ë  ìˆ˜ ìžˆìŠµë‹ˆë‹¤
          EOF
          
          echo "ðŸŽ‰ ë¡¤ë°±ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ë²„ì „: $TARGET_VERSION"
          echo "ì‚¬ì´íŠ¸: https://woo-bottle.com"
